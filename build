#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

load_helpers() {
  local helper_paths=(
    "${SCRIPT_HELPERS_DIR:-}"
    "${ROOT_DIR}/script-helpers"
    "${ROOT_DIR}/../script-helpers"
  )
  for path in "${helper_paths[@]}"; do
    if [[ -n "$path" && -f "$path/helpers.sh" ]]; then
      # shellcheck disable=SC1090
      source "$path/helpers.sh"
      return 0
    fi
  done
  echo "script-helpers not found. Run ./update to fetch submodules (or set SCRIPT_HELPERS_DIR)." >&2
  exit 1
}

load_helpers
shlib_import logging

BACKEND_DIR="${ROOT_DIR}/backend"
FRONTEND_DIR="${ROOT_DIR}/frontend"
VENV_DIR="${BACKEND_DIR}/.venv"

if ! command -v python3 >/dev/null 2>&1; then
  log_error "python3 not found"
  exit 1
fi

if ! command -v npm >/dev/null 2>&1; then
  log_error "npm not found"
  exit 1
fi

log_info "Building backend dependencies"
python3 -m venv "$VENV_DIR"
# shellcheck source=/dev/null
source "${VENV_DIR}/bin/activate"
pip install --upgrade pip >/dev/null
pip install -r "${BACKEND_DIR}/requirements.txt"
deactivate

log_info "Building frontend (production bundle)"
(
  cd "$FRONTEND_DIR"
  npm install
  npm run build
)

log_info "Build completed successfully."
